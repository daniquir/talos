services:
  # LAYER 1: The Web (Public)
  talos-web:
    build: ./talos-web
    container_name: talos-web
    ports:
      - "3000:3000"
      - "3443:3443"
    environment:
      - DEBUG=true
      - DATABASE_URL=sqlite:/data/talos.db
    volumes:
      - ./data/web:/data
    networks:
      - net_public  # Accessible from your browser
      - net_middleware # Secure channel to Storage
    restart: always

  # LAYER 2: The Storage (The Bridge)
  talos-storage:
    build: ./talos-storage
    container_name: talos-storage
    environment:
      - GPG_ID=${GPG_ID:-admin@talos.local}
      - DEBUG=true
    volumes:
      - ./data/password-store:/home/talosuser/.password-store:rw
      - ./config:/app/config:ro
      - ./data/ssh/id_rsa_talos:/run/secrets/id_rsa_talos:ro # Mount your SSH key for Git
    networks:
      - net_middleware # Only accepts requests from Web
      - net_private    # Exclusive channel to Bunker
    restart: always

  # LAYER 3: The Bunker (Totally Isolated)
  talos-bunker:
    build: ./talos-bunker
    container_name: talos-bunker
    environment:
      - GPG_ID=${GPG_ID:-admin@talos.local}
      - DEBUG=true
    networks:
      - net_private # Only sees Storage, no one else sees it
    restart: always

networks:
  # This network does NOT have 'internal: true', allowing port mapping
  net_public:
    driver: bridge

  # Isolates Web-Storage communication from outside world
  net_middleware:
    internal: true

  # This network IS internal. The Bunker is in a digital black hole.
  net_private:
    internal: true